name: INFY Stock Forecast - CI & Training

on:
  # Quick CI on every push / PR
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Manual trigger from GitHub UI
  workflow_dispatch:

  # Optional: scheduled full training + drift check (weekdays 6:30 IST ≈ 01:00 UTC)
  schedule:
    - cron: "30 1 * * 1-5"

jobs:
  # ---------- 1) Fast checks: run on every push ----------
  quick-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Syntax check (py_compile)
        run: |
          python -m py_compile src/*.py train_models.py predict_infys.py app.py

  # ---------- 2) Full pipeline: data → training → drift ----------
  train-and-drift:
    runs-on: ubuntu-latest
    needs: quick-ci     # only run if quick-ci passes

    # Only run automatically on schedule, manual, or explicit label.
    # (It will still run on push because 'on' includes push, but you can
    #  remove 'push' at top if you want it ONLY scheduled/manual.)
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (full)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run data download
        run: |
          python src/download_data.py

      - name: Run data cleaning
        run: |
          python src/clean_data.py

      - name: Run feature engineering
        run: |
          python src/feature_engineering.py

      - name: Train models with MLflow logging
        run: |
          python train_models.py

      - name: Run drift monitoring
        run: |
          python src/monitor_drift.py
